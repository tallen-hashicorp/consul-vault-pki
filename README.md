# consul-vault-pki
Consul running in K8s using Vault PKI as a CA

# Vault
First run vault in Dev mode, we will connect consul to this later
```bash
vault server -dev -dev-root-token-id root
```

Now in a different terminal, run the setup script. This will log you into Vault, enable the PKI secrets engine, generate and configure a root CA, create an intermediate CA, define a role for issuing certificates, and finally request a certificate for a specified common name. This setup ensures a complete PKI infrastructure in Vault, allowing you to manage and issue certificates securely.
```bash
sh setup-vault-pki.sh
```

this creates 4 files:

1. **pki_intermediate.csr**:
   - This file contains a Certificate Signing Request (CSR) for the intermediate CA. A CSR is a message sent from an applicant to a Certificate Authority, requesting a new certificate. It includes information such as the applicant's distinguished name, public key, and desired attributes of the certificate. In this script, `pki_intermediate.csr` is generated to request the signing of the intermediate CA certificate by the root CA.

2. **root_2023_ca.crt**:
   - This file contains the root CA certificate. The root CA is the top-level certificate in a Public Key Infrastructure (PKI) hierarchy. It is self-signed and used to sign other certificates, including intermediate CAs. The `root_2023_ca.crt` file stores the root CA certificate generated by the script. This certificate is crucial for establishing trust within the PKI infrastructure, as it is used to verify the authenticity of certificates signed by the root CA.

3. **intermediate.cert.pem**:
    - This file contains the signed certificate for the intermediate CA. After generating a Certificate Signing Request (CSR) for the intermediate CA (`pki_intermediate.csr`), the script sends this CSR to the root CA (`root_2023_ca.crt`) for signing.
    - The root CA then signs the CSR and returns the signed certificate, which is saved as `intermediate.cert.pem`.
    - The `intermediate.cert.pem` file represents the intermediate CA's certificate, which is issued by the root CA. It contains the intermediate CA's public key, along with other information such as its validity period and issuer details.
    - This intermediate CA certificate is crucial for establishing a chain of trust within the Public Key Infrastructure (PKI) hierarchy. It is used to sign end-entity certificates (e.g., website certificates) and validate their authenticity in the trust chain.

Now we have done this lets add the Root CA Certificate to Keychain
- Open Keychain Access (`/Applications/Utilities/Keychain Access.app`).
- Drag and drop the `root_2023_ca.crt` file into the "System" or "System Roots" keychain.
- Double-click the certificate in Keychain Access and set the "Trust" settings to "Always Trust".

By adding the root CA certificate to your Keychain, you establish trust for certificates issued by the intermediate CA. This is because the intermediate CA's certificate (`intermediate.cert.pem`) is signed by the root CA, and trust is inherited from the root CA.

You typically don't need to add the intermediate CA certificate separately to your trust store unless you have specific use cases that require it. The intermediate CA certificate is used by the system to validate certificates issued by the intermediate CA, but trust is ultimately established through the root CA certificate.


# Consul
